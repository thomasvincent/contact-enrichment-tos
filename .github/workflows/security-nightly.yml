name: Nightly Security Scan

on:
  schedule:
    - cron: '30 3 * * *' # 03:30 UTC nightly
  workflow_dispatch:

env:
  JAVA_VERSION: '21'

jobs:
  security:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Cache Dependency-Check data directory
        uses: actions/cache@v4
        with:
          path: ~/.cache/depcheck
          key: ${{ runner.os }}-depcheck-${{ hashFiles('implementations/java/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-depcheck-

      - name: Write Maven toolchains.xml (JDK 21)
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/toolchains.xml << 'EOF'
          <toolchains>
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>21</version>
                <vendor>any</vendor>
              </provides>
              <configuration>
                <jdkHome>${JAVA_HOME}</jdkHome>
              </configuration>
            </toolchain>
          </toolchains>
          EOF

      - name: Security scan (SBOM + OWASP DC)
        env:
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
        run: |
          ./implementations/java/mvnw -f implementations/java/pom.xml -P security-scan -DskipTests -Djacoco.skip=true -B verify

      - name: Upload Dependency-Check SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: implementations/java/target/security-reports/dependency-check-report.sarif

      - name: Upload SBOM (CycloneDX)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-sbom
          path: |
            implementations/java/target/sbom/bom.xml
            implementations/java/target/sbom/bom.json

      - name: Install OSV-Scanner
        run: |
          curl -sSfL https://github.com/google/osv-scanner/releases/latest/download/osv-scanner_linux_amd64 -o osv-scanner
          chmod +x osv-scanner
          sudo mv osv-scanner /usr/local/bin/

      - name: Run OSV-Scanner (source + SBOM)
        continue-on-error: true
        run: |
          osv-scanner --format sarif --output osv-nightly.sarif \
            --lockfile implementations/java/pom.xml \
            --sbom implementations/java/target/sbom/bom.json || true

      - name: Upload OSV results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: osv-nightly.sarif